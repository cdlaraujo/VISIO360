<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador 3D Colaborativo</title>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.151.3/build/three.module.js",
            "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.151.3/examples/jsm/"
        }
    }
    </script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* General Styles */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #f0f0f0; background-color: #1a1a1a; overflow: hidden; }
        #app { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        #ui-container { position: fixed; top: 20px; left: 20px; z-index: 10; background-color: rgba(40, 40, 40, 0.95); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); width: 340px; max-height: calc(100vh - 40px); overflow-y: auto; }
        h1 { margin-top: 0; font-size: 1.5em; color: #ffffff; border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 15px; }
        .section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #444; }
        .section-title { font-size: 1.1em; color: #00d4ff; margin-bottom: 15px; font-weight: bold; }
        .hint { font-size: 0.8em; color: #aaa; margin: 10px 0; text-align: left; line-height: 1.4; }
        .btn { padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; transition: all 0.3s ease; font-size: 0.95em; width: 100%; margin-top: 5px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #218838; }
        .input-field { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #555; border-radius: 6px; background: rgba(0, 0, 0, 0.3); color: white; font-size: 0.95em; }
        input[type="file"] { display: none; }
        .custom-file-upload { display: block; width: 100%; padding: 12px 0; border-radius: 8px; background-color: #555; color: white; text-align: center; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .custom-file-upload:hover { background-color: #666; }

        /* Collaboration UI */
        #room-connect-panel, #join-room-input { display: grid; gap: 10px; }
        .status-indicator { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #ff4444; }
        .status-dot.connected { background: #4CAF50; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .room-code-display { margin: 15px 0; }
        .room-code { background: rgba(0, 0, 0, 0.5); padding: 12px; border-radius: 6px; font-family: monospace; font-size: 1.2em; text-align: center; margin: 8px 0; letter-spacing: 2px; user-select: all; }
        .peers-list { margin-top: 15px; padding-top: 15px; border-top: 1px solid #555; }
        #peers-container { margin-top: 10px; max-height: 100px; overflow-y: auto; }
        .peer-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; margin-bottom: 6px; }
        .peer-color-dot { width: 12px; height: 12px; border-radius: 50%; }

        /* Tools & Measurements */
        .tools-section { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .tool-btn { padding: 12px 8px; border-radius: 8px; background-color: #555; color: white; text-align: center; font-weight: bold; cursor: pointer; border: none; transition: all 0.3s ease; font-size: 0.9em; }
        .tool-btn:hover { background-color: #666; transform: translateY(-1px); }
        .tool-btn.active { background-color: #007bff; box-shadow: 0 0 10px rgba(0, 123, 255, 0.4); }
        .clear-btn { background-color: #dc3545 !important; grid-column: 1 / -1; }
        .clear-btn:hover { background-color: #c82333 !important; }
        .instructions-panel { margin: 15px 0; padding: 12px; background-color: rgba(0, 123, 255, 0.1); border-left: 3px solid #007bff; border-radius: 6px; display: none; }
        .instructions-panel.show { display: block; }
        .measurements-panel { margin-top: 20px; padding-top: 15px; border-top: 1px solid #555; display: none; }
        .measurement-group h4 { margin: 0 0 8px 0; font-size: 1em; color: #ccc; font-weight: normal; }
        .measurement-list { background-color: rgba(255, 255, 255, 0.05); border-radius: 6px; padding: 8px; min-height: 30px; max-height: 120px; overflow-y: auto; }
        .measurement-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; margin-bottom: 4px; background-color: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        .measurement-value { font-family: 'Courier New', monospace; font-weight: bold; color: #00d4ff; font-size: 0.95em; }
        .delete-btn { background: #dc3545; border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 12px; line-height: 1; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; }
        .delete-btn:hover { background: #c82333; transform: scale(1.1); }

        /* Loading & Notifications */
        .loading-spinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; z-index: 1001; }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        .notification { position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; font-size: 14px; animation: slideIn 0.3s ease forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="app"></div>

    <div id="loading" class="loading-spinner"></div>

    <div id="ui-container">
        <h1>Visio360 Colaborativo</h1>

        <div id="room-section" class="section">
            <div class="section-title">Sala de Colabora√ß√£o</div>
            <div id="room-connect-panel">
                <input type="text" id="user-name-input" class="input-field" placeholder="Seu nome" value="Usu√°rio">
                <button id="create-room-btn" class="btn btn-success">üöÄ Criar Nova Sala</button>
                <button id="join-room-btn" class="btn btn-secondary">üîó Entrar em Sala Existente</button>
                <div id="join-room-input" style="display: none; margin-top: 10px;">
                    <input type="text" id="room-id-input" class="input-field" placeholder="C√≥digo da sala (e.g. ABC123)">
                    <button id="join-room-confirm-btn" class="btn btn-primary">Entrar Agora</button>
                </div>
            </div>
            <div id="room-info-panel" style="display: none;">
                <div class="status-indicator">
                    <span id="status-dot" class="status-dot"></span>
                    <span id="connection-status">Desconectado</span>
                </div>
                <div class="room-code-display">
                    <label>C√≥digo da Sala:</label>
                    <div class="room-code" id="room-code-display"></div>
                    <button id="copy-room-btn" class="btn btn-primary">üìã Copiar Link de Convite</button>
                </div>
                <div class="peers-list">
                    <label>üë• Usu√°rios Online: <span id="peer-count">1</span></label>
                    <div id="peers-container"></div>
                </div>
            </div>
        </div>

        <div id="model-loading-section" class="section">
            <div class="section-title">Modelo 3D</div>
            <div id="model-input-area">
                <p class="hint">Para colaborar, o modelo 3D precisa estar em um link p√∫blico (URL).</p>
                <input type="text" id="model-url-input" class="input-field" placeholder="Cole a URL do modelo (.glb, .gltf, .ply)">
                <button id="load-model-url-btn" class="btn btn-primary">Carregar Modelo via URL</button>
                <div style="text-align:center; margin:10px 0; color: #888;">OU</div>
                <label for="model-input" class="custom-file-upload">
                    üìÅ Carregar do Computador (Apenas Visualiza√ß√£o Local)
                </label>
                <input type="file" id="model-input" accept=".ply,.gltf,.glb" />
            </div>
            <div id="model-info-area" style="display:none;">
                <p style="margin: 0;">Modelo Carregado: <b id="model-name-display"></b></p>
                <button id="change-model-btn" class="btn btn-secondary">Trocar Modelo</button>
            </div>
        </div>

        <div class="tools-section">
            <button id="measure-tool-btn" class="tool-btn">üìè Dist√¢ncia</button>
            <button id="area-tool-btn" class="tool-btn">üìê √Årea Plana</button>
            <button id="surface-area-tool-btn" class="tool-btn">üóª √Årea Real</button>
            <button id="clear-all-btn" class="tool-btn clear-btn">üóëÔ∏è Limpar Medi√ß√µes</button>
        </div>

        <div id="instructions-panel" class="instructions-panel">
            <p id="tool-instructions" style="margin:0;"></p>
        </div>

        <div id="measurements-panel" class="measurements-panel">
            <h3>Minhas Medi√ß√µes</h3>
            <div id="distance-measurements" class="measurement-group">
                <h4>Dist√¢ncias</h4>
                <div id="distance-list" class="measurement-list"></div>
            </div>
            <div id="area-measurements" class="measurement-group">
                <h4>√Åreas Planas</h4>
                <div id="area-list" class="measurement-list"></div>
            </div>
            <div id="surface-area-measurements" class="measurement-group">
                <h4>√Åreas Reais (Superf√≠cie)</h4>
                <div id="surface-area-list" class="measurement-list"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { App } from './src/app/App.js';

        // Graceful error handling
        function handleGlobalError(error) {
            console.error('‚ùå Erro fatal na aplica√ß√£o:', error);
            const spinner = document.getElementById('loading');
            if (spinner) spinner.style.display = 'none';

            const appContainer = document.getElementById('app');
            if (appContainer) {
                appContainer.innerHTML = `
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #ff4444; background: rgba(0, 0, 0, 0.9); padding: 30px; border-radius: 12px; border: 1px solid #ff4444;">
                        <h2>üö® Erro na Aplica√ß√£o</h2>
                        <p>N√£o foi poss√≠vel carregar o visualizador 3D.</p>
                        <p><strong>Motivo:</strong> ${error.message || 'Erro desconhecido'}</p>
                        <p style="font-size: 0.9em; color: #aaa; margin-top: 15px;">Verifique o console do navegador (F12) para mais detalhes.</p>
                        <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-top: 20px; font-size: 1em;">üîÑ Tentar Novamente</button>
                    </div>
                `;
            }
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const appContainer = document.getElementById('app');
                if (!appContainer) throw new Error('Container #app n√£o encontrado no DOM');

                // Check WebGL support
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) throw new Error('Seu navegador n√£o suporta WebGL, que √© necess√°rio para rodar esta aplica√ß√£o.');

                console.log('üöÄ Inicializando Visualizador 3D Colaborativo...');
                const app = new App(appContainer);
                await app.start();

                // Expose app for debugging and UI interaction
                window.app = app;
                console.log('‚úÖ Aplica√ß√£o inicializada com sucesso!');
                console.log('üí° Dica: Use window.app.getModules() no console para inspecionar os m√≥dulos internos.');

            } catch (error) {
                handleGlobalError(error);
            }
        });

        // Global error listeners
        window.addEventListener('error', (event) => handleGlobalError(event.error));
        window.addEventListener('unhandledrejection', (event) => handleGlobalError(new Error(event.reason || 'Promise Rejection')));
    </script>
</body>
</html>