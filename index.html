<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador 3D Colaborativo</title>
    <link rel="stylesheet" href="/src/style.css" />
    <script type="importmap">
{
    "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.151.3/build/three.module.js",
        "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.151.3/examples/jsm/"
    }
}
    </script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <div id="app"></div>
    <div id="loading" class="loading-spinner"></div>
    <div id="progress-bar-container" class="progress-bar-container">
        <p class="progress-text">Carregando modelo... <span id="progress-percentage">0%</span></p>
        <div class="progress-bar">
            <div id="progress-bar-fill" class="progress-bar-fill"></div>
        </div>
    </div>

    <div id="ui-container">
        <h1>Visio3D Colaborativo</h1>
        <div id="room-section" class="section">
            <div class="section-title">Sala de ColaboraÃ§Ã£o</div>
            <div id="room-connect-panel">
                <input type="text" id="user-name-input" class="input-field" placeholder="Seu nome" value="UsuÃ¡rio">
                <button id="create-room-btn" class="btn btn-success">ğŸš€ Criar Nova Sala</button>
                <button id="join-room-btn" class="btn btn-secondary">ğŸ”— Entrar em Sala</button>
                <div id="join-room-input" style="display: none; margin-top: 10px;">
                    <input type="text" id="room-id-input" class="input-field" placeholder="CÃ³digo da sala (e.g. ABC123)">
                    <button id="join-room-confirm-btn" class="btn btn-primary">Entrar Agora</button>
                </div>
            </div>
            <div id="room-info-panel" style="display: none;">
                <div class="status-indicator">
                    <span id="status-dot" class="status-dot"></span>
                    <span id="connection-status">Desconectado</span>
                </div>
                <div class="room-code-display">
                    <label>CÃ³digo da Sala:</label>
                    <div class="room-code" id="room-code-display"></div>
                    <button id="copy-room-btn" class="btn btn-primary">ğŸ“‹ Copiar Link de Convite</button>
                </div>
                <div class="peers-list">
                    <label>ğŸ‘¥ UsuÃ¡rios Online: <span id="peer-count">1</span></label>
                    <div id="peers-container"></div>
                </div>
            </div>
        </div>
        <div id="model-loading-section" class="section">
            <div class="section-title">Modelo 3D</div>
            <div id="model-input-area">
                <p class="hint">Cole um link pÃºblico (URL) do seu modelo 3D.</p>
                <input type="text" id="model-url-input" class="input-field" placeholder="URL do modelo (.glb, .gltf, .ply)">
                <button id="load-model-url-btn" class="btn btn-primary">Carregar Modelo via URL</button>
                <div style="text-align:center; margin:10px 0; color: #888;">OU</div>
                <label for="model-input" class="custom-file-upload">
                    ğŸ“ Carregar do Computador (Individual)
                </label>
                <input type="file" id="model-input" accept=".ply,.gltf,.glb" />
            </div>
            <div id="model-info-area" style="display:none;">
                <p style="margin: 0;">Modelo: <b id="model-name-display"></b></p>
                <button id="change-model-btn" class="btn btn-secondary">Trocar Modelo</button>
            </div>
        </div>
        <div class="tools-section">
            <button id="measure-tool-btn" class="tool-btn">ğŸ“ DistÃ¢ncia</button>
            <button id="area-tool-btn" class="tool-btn">ğŸ“ Ãrea Plana</button>
            <button id="surface-area-tool-btn" class="tool-btn">ğŸ—» Ãrea de SuperfÃ­cie</button>
            <button id="clear-all-btn" class="tool-btn clear-btn">ğŸ—‘ï¸ Limpar MediÃ§Ãµes</button>
        </div>
        <div id="instructions-panel" class="instructions-panel">
            <p id="tool-instructions" style="margin:0;"></p>
        </div>
        <div id="measurements-panel" class="measurements-panel section">
            <div class="section-title">MediÃ§Ãµes</div>
            <div id="measurements-container">
        </div>
</div>
    </div>

    <script type="module">
        import { App } from './src/app/App.js';

        function handleGlobalError(error) {
            console.error('âŒ Erro fatal na aplicaÃ§Ã£o:', error);
            document.getElementById('loading')?.remove();
            document.getElementById('progress-bar-container')?.remove();
            const appContainer = document.getElementById('app');
            if (appContainer) {
                appContainer.innerHTML = `
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #ff4444; background: rgba(0, 0, 0, 0.9); padding: 30px; border-radius: 12px; border: 1px solid #ff4444;">
                        <h2>ğŸš¨ Erro na AplicaÃ§Ã£o</h2>
                        <p><strong>Motivo:</strong> ${error.message || 'Erro desconhecido'}</p>
                        <p style="font-size: 0.9em; color: #aaa; margin-top: 15px;">Verifique o console do navegador (F12) para detalhes.</p>
                        <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-top: 20px;">ğŸ”„ Tentar Novamente</button>
                    </div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const appContainer = document.getElementById('app');
                if (!appContainer) throw new Error('Container #app nÃ£o encontrado no DOM');
                
                const app = new App(appContainer);
                await app.start();

                window.app = app;
                console.log('âœ… AplicaÃ§Ã£o inicializada com sucesso!');
            } catch (error) {
                handleGlobalError(error);
            }
        });
    </script>
</body>
</html>